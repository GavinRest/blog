import{_ as i,c as a,o as n,ae as t}from"./chunks/framework.BHrE6nLq.js";const l="/images/tcpip/layer3/ip_fragment.png",d=JSON.parse('{"title":"IP Fragmentation（IP 分片）","description":"","frontmatter":{},"headers":[],"relativePath":"network/tcpip/layer3/ip_fragment.md","filePath":"network/tcpip/layer3/ip_fragment.md"}'),h={name:"network/tcpip/layer3/ip_fragment.md"};function e(p,s,k,r,F,o){return n(),a("div",null,s[0]||(s[0]=[t('<h1 id="ip-fragmentation-ip-分片" tabindex="-1"><strong>IP Fragmentation（IP 分片）</strong> <a class="header-anchor" href="#ip-fragmentation-ip-分片" aria-label="Permalink to &quot;**IP Fragmentation（IP 分片）**&quot;">​</a></h1><blockquote><p><strong>背景</strong>：当 IP 数据包的大小超过 MTU（Maximum Transmission Unit, 最大传输单元）时，IP 层需要对数据进行分片，否则数据包将被丢弃。分片发生在 <strong>出方向</strong> 的接口上。<br><strong>参考</strong>：<a href="./../layer2/mtu.html">MTU 介绍</a></p></blockquote><h2 id="_1-ip-分片实例-以太网环境" tabindex="-1"><strong>1. IP 分片实例（以太网环境）</strong> <a class="header-anchor" href="#_1-ip-分片实例-以太网环境" aria-label="Permalink to &quot;**1. IP 分片实例（以太网环境）**&quot;">​</a></h2><hr><h3 id="分片过程" tabindex="-1"><strong>分片过程</strong> <a class="header-anchor" href="#分片过程" aria-label="Permalink to &quot;**分片过程**&quot;">​</a></h3><ul><li>以太网的默认 <strong>MTU</strong> 为 <strong>1500 字节</strong>，IP 头部占 <strong>20 字节</strong>，因此 IP 层最大有效载荷（payload）为 <strong>1480 字节</strong>。</li><li>若传输的数据超过 <strong>1480 字节</strong>，则 IP 协议需要进行分片。</li><li>IP 层的分片对 <strong>传输层协议（TCP/UDP）是透明的</strong>，即 TCP/UDP 本身不关心分片的过程。</li></ul><h3 id="示例" tabindex="-1"><strong>示例</strong> <a class="header-anchor" href="#示例" aria-label="Permalink to &quot;**示例**&quot;">​</a></h3><p>假设使用 <strong>UDP</strong> 传输 <strong>2000 字节</strong>的数据，加上 <strong>8 字节的 UDP 头部</strong>，IP 层总共需要传输 <strong>2008 字节</strong>：</p><ul><li><strong>第一个 IP 包</strong>： <ul><li><strong>UDP 头部 (8B) + 数据载荷 (1472B) = 1480B</strong></li></ul></li><li><strong>第二个 IP 包</strong>： <ul><li><strong>无 UDP 头部，仅有剩余载荷 (528B)</strong></li></ul></li></ul><h3 id="分片示意图" tabindex="-1"><strong>分片示意图</strong> <a class="header-anchor" href="#分片示意图" aria-label="Permalink to &quot;**分片示意图**&quot;">​</a></h3><p><img src="'+l+`" alt="IP包分片"></p><h3 id="分片标志位-flags-字段" tabindex="-1"><strong>分片标志位（Flags 字段）</strong> <a class="header-anchor" href="#分片标志位-flags-字段" aria-label="Permalink to &quot;**分片标志位（Flags 字段）**&quot;">​</a></h3><p>IP 头部的 <strong>Flags</strong> 字段用于控制分片：</p><ul><li><code>More Fragments</code>（MF）= <code>1</code>：表示该分片 <strong>后面还有更多分片</strong>。</li><li><code>More Fragments</code>（MF）= <code>0</code>：表示该分片是 <strong>最后一个分片</strong>。</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Flags: 0x00</span></span>
<span class="line"><span>0... .... = Reserved bit: Not set</span></span>
<span class="line"><span>.0.. .... = Don&#39;t fragment: Not set</span></span>
<span class="line"><span>..0. .... = More fragments: Not set   // 被分片的包除最后一个均为1。</span></span></code></pre></div><h2 id="_2-禁止-ip-分片-don-t-fragment-df-标志位" tabindex="-1"><strong>2. 禁止 IP 分片（Don&#39;t Fragment，DF 标志位）</strong> <a class="header-anchor" href="#_2-禁止-ip-分片-don-t-fragment-df-标志位" aria-label="Permalink to &quot;**2. 禁止 IP 分片（Don&#39;t Fragment，DF 标志位）**&quot;">​</a></h2><h3 id="概述" tabindex="-1"><strong>概述</strong> <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;**概述**&quot;">​</a></h3><p>IP 头部的 <strong>DF（Don&#39;t Fragment）标志位</strong> 控制是否允许分片：</p><ul><li><strong>DF = 1</strong>：不允许分片，如果数据包超过 MTU，则直接丢弃。</li><li><strong>DF = 0</strong>：允许分片，当数据包超过 MTU 时，会被拆分成多个 IP 片段。</li></ul><h3 id="_2-1-使用-ping-命令测试-df-标志位" tabindex="-1"><strong>2.1 使用 ping 命令测试 DF 标志位</strong> <a class="header-anchor" href="#_2-1-使用-ping-命令测试-df-标志位" aria-label="Permalink to &quot;**2.1 使用 ping 命令测试 DF 标志位**&quot;">​</a></h3><p>可以使用 <code>ping</code> 命令手动指定 <strong>DF 置位</strong>，以测试网络路径上的 MTU 限制。</p><h4 id="linux-ubuntu-centos" tabindex="-1"><strong>Linux (Ubuntu, CentOS)</strong> <a class="header-anchor" href="#linux-ubuntu-centos" aria-label="Permalink to &quot;**Linux (Ubuntu, CentOS)**&quot;">​</a></h4><ul><li><code>-M do</code>：设置 DF 标志位，确保数据包不会被分片。</li><li><code>-s</code>：指定 ICMP 报文的大小。</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Ubunut</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ping</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -M</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> do</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> www.baidu.com</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1472</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PING</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> www.a.shifen.com</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (180.101.49.11) 1472(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1480</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 180.101.49.11:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">52</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4.84</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1480</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 180.101.49.11:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">52</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4.82</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ping</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -M</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> do</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> www.baidu.com</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1473</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PING</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> www.a.shifen.com</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (180.101.49.11) 1473(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1501</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ping:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> local</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> error:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Message</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> too</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> long,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mtu=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1500</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ping:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> local</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> error:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Message</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> too</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> long,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mtu=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1500</span></span></code></pre></div><h4 id="macos" tabindex="-1"><strong>Macos</strong> <a class="header-anchor" href="#macos" aria-label="Permalink to &quot;**Macos**&quot;">​</a></h4><ul><li><code>-D</code>：设置 DF 标志位，防止分片。</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># MacOS</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ping -D www.baidu.com -s 1472</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PING</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> www.a.shifen.com</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (182.61.200.7): 1472 data bytes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1480</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 182.61.200.7:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">54</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5.904</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1480</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 182.61.200.7:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">54</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5.651</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ping -D www.baidu.com -s 1473</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PING</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> www.a.shifen.com</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (182.61.200.7): 1473 data bytes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ping:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sendto:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Message</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> too</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> long</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ping:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sendto:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Message</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> too</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> long</span></span></code></pre></div><h3 id="扩展" tabindex="-1">扩展 <a class="header-anchor" href="#扩展" aria-label="Permalink to &quot;扩展&quot;">​</a></h3><ul><li><p>如何避免 UDP 过大，造成 ip 层分片？</p><ul><li>QUIC（Quick UDP Internet Connection）</li></ul></li></ul>`,29)]))}const c=i(h,[["render",e]]);export{d as __pageData,c as default};
